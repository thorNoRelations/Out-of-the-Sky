{% extends 'base.html' %}
{% load static %}

{% block title %}Weather & Delay Insights - Out of the Sky{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background: var(--bg-light); }
        .weather-hero {
            background: var(--gradient-primary);
            padding: 8rem 0 4rem;
            margin-top: 0; /* Adjusted since we're in main block, but sticky navbar might overlay if margin is 0? Base.html main has no padding top by default? No, sticky navbar means content starts at top of viewport but is obscured. Base.html usually needs body { padding-top: navbar-height } or main { padding-top }. */
            /* Actually, Bootstrap 5 sticky-top doesn't reserve space. 
               However, base.html has navbar inside body. 
               If I use block main, I replace the container. 
               I should check if content is hidden behind navbar. 
               Usually sticky-top requires subsequent content to have margin-top or body to have padding-top. 
               Or I can just add margin-top to weather-hero. 
               Let's assume standard behavior and add some top padding/margin if needed.
            */
            position: relative;
            overflow: hidden;
        }

        .weather-hero::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(6, 182, 212, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.3) 0%, transparent 50%);
        }

        .weather-hero-content {
            position: relative;
            z-index: 1;
            text-align: center;
            color: white;
        }

        .weather-hero h1 {
            font-size: 3rem; font-weight: 700; margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .weather-hero p { font-size: 1.2rem; opacity: 0.95; }

        .weather-content { padding: 3rem 0; }

        .search-box {
            background: white; padding: 2rem; border-radius: 20px;
            box-shadow: var(--shadow-lg); margin-bottom: 2rem;
        }

        .search-input {
            width: 100%; padding: 1rem 1.5rem; border: 2px solid #e5e7eb;
            border-radius: 50px; font-size: 1rem; font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 3rem;
        }

        .stat-card {
            background: white; padding: 2rem; border-radius: 15px;
            text-align: center; box-shadow: var(--shadow-md); transition: all 0.3s ease;
        }

        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-xl); }

        .stat-number {
            font-size: 2.5rem; font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 0.5rem;
        }

        .stat-label { font-size: 1rem; color: var(--text-light); font-weight: 500; }

        .weather-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem;
        }

        .weather-card {
            background: white; border-radius: 20px; padding: 2rem;
            box-shadow: var(--shadow-md); transition: all 0.3s ease;
        }

        .weather-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-xl); }

        .airport-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--bg-light);
        }

        .airport-code {
            font-size: 2rem; font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .airport-name { font-size: 0.9rem; color: var(--text-light); margin-top: 0.25rem; }

        .weather-main {
            display: flex; align-items: center; gap: 2rem; padding: 1.5rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 15px; margin-bottom: 1.5rem;
        }

        .weather-icon-large { font-size: 4rem; flex-shrink: 0; }
        .weather-info { flex: 1; }

        .temp-display { font-size: 3rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0.25rem; }
        .condition-display { font-size: 1.1rem; color: var(--text-light); font-weight: 500; }

        .weather-details {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;
        }

        .detail-box {
            padding: 1rem; background: var(--bg-light); border-radius: 12px;
            text-align: center; transition: all 0.3s ease;
        }

        .detail-box:hover { background: #e0f2fe; }

        .detail-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }
        .detail-value { font-size: 1.2rem; font-weight: 700; color: var(--text-dark); }

        .delay-risk-box {
            padding: 1.5rem; border-radius: 15px; text-align: center; margin-bottom: 1rem;
        }

        .risk-low { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
        .risk-moderate { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }
        .risk-high { background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); color: #9a3412; }
        .risk-severe { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }

        .risk-title {
            font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .risk-level { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; }
        .risk-details { font-size: 0.95rem; opacity: 0.9; }

        .forecast-description {
            padding: 1rem; background: var(--bg-light);
            border-left: 4px solid var(--primary-color); border-radius: 8px;
            font-size: 0.95rem; color: var(--text-dark); line-height: 1.6; margin-bottom: 1rem;
        }

        .last-updated { font-size: 0.8rem; color: var(--text-light); text-align: center; }

        .empty-state {
            text-align: center; padding: 4rem 2rem; background: white;
            border-radius: 20px; box-shadow: var(--shadow-md);
        }

        .empty-icon { font-size: 5rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state h2 { font-size: 2rem; color: var(--text-dark); margin-bottom: 1rem; }
        .empty-state p { color: var(--text-light); font-size: 1.1rem; }

        @media (max-width: 768px) {
            .weather-hero { padding: 6rem 0 3rem; }
            .weather-hero h1 { font-size: 2rem; }
            .weather-hero p { font-size: 1rem; }
            .weather-grid { grid-template-columns: 1fr; }
            .weather-main { flex-direction: column; text-align: center; }
            .weather-details { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: 1fr; }
        }
    </style>
{% endblock %}

{% block main %}
    {% if messages %}
        <div class="container mt-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Hero Section -->
    <section class="weather-hero">
        <div class="container weather-hero-content">
            <h1>üå§Ô∏è Weather & Delay Insights</h1>
            <p>Real-time weather forecasts and delay predictions for airports worldwide</p>
        </div>
    </section>

    <!-- Main Content -->
    <section class="weather-content">
        <div class="container">
            <!-- Search Box -->
            <div class="search-box">
                <form method="GET" action="{% url 'home:weather_insights' %}">
                    <input 
                        type="text" 
                        name="q"
                        class="search-input" 
                        placeholder="üîç Search airports (e.g., DEN, Denver, LAX)" 
                        value="{{ search_query }}"
                    >
                </form>
            </div>

            {% if error %}
            <div class="alert alert-danger mb-4">
                ERROR: {{ error }}
            </div>
            {% endif %}

            {% if weather %}
            <div class="alert alert-info mb-4">
                <h2>{{ weather.city }}</h2>
                <p><b>Temperature:</b> {{ weather.temp }}¬∞F</p>
                <p><b>Condition:</b> {{ weather.condition }}</p>
            </div>
            {% endif %}

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-number">{{ total_airports }}</div>
                    <div class="stat-label">Airports Monitored</div>
                </div>
            </div>

            <!-- Weather Cards -->
            {% if airports_weather %}
                <div class="weather-grid">
                    {% for weather in airports_weather %}
                    <div class="weather-card">
                        <!-- Airport Header -->
                        <div class="airport-header">
                            <div>
                                <div class="airport-code">{{ weather.airport_code }}</div>
                                <div class="airport-name">{{ weather.airport_name }}</div>
                            </div>
                        </div>

                        <!-- Main Weather Display -->
                        <div class="weather-main">
                            <div class="weather-icon-large">{{ weather.get_weather_icon }}</div>
                            <div class="weather-info">
                                <div class="temp-display">{{ weather.temperature }}¬∞F</div>
                                <div class="condition-display">{{ weather.get_condition_display }}</div>
                            </div>
                        </div>

                        <!-- Weather Details Grid -->
                        <div class="weather-details">
                            <div class="detail-box">
                                <div class="detail-label">üí® Wind Speed</div>
                                <div class="detail-value">{{ weather.wind_speed }} mph</div>
                            </div>
                            <div class="detail-box">
                                <div class="detail-label">üëÅÔ∏è Visibility</div>
                                <div class="detail-value">{{ weather.visibility }} mi</div>
                            </div>
                            <div class="detail-box">
                                <div class="detail-label">üåßÔ∏è Precipitation</div>
                                <div class="detail-value">{{ weather.precipitation_chance }}%</div>
                            </div>
                            <div class="detail-box">
                                <div class="detail-label">üïê Forecast Time</div>
                                <div class="detail-value" style="font-size: 0.9rem;">
                                    {{ weather.forecast_time|date:"M d, H:i" }}
                                </div>
                            </div>
                        </div>

                        <!-- Delay Risk Box -->
                        <div class="delay-risk-box risk-{{ weather.delay_risk }}">
                            <div class="risk-title">‚ö†Ô∏è Delay Risk Assessment</div>
                            <div class="risk-level">{{ weather.get_delay_risk_display }}</div>
                            <div class="risk-details">
                                {{ weather.delay_probability }}% probability
                                {% if weather.estimated_delay_minutes > 0 %}
                                    ‚Ä¢ Est. {{ weather.estimated_delay_minutes }} min delay
                                {% endif %}
                            </div>
                        </div>

                        <!-- Forecast Description -->
                        {% if weather.forecast_description %}
                        <div class="forecast-description">
                            {{ weather.forecast_description }}
                        </div>
                        {% endif %}

                        <!-- Last Updated -->
                        <div class="last-updated">
                            Last updated: {{ weather.last_updated|timesince }} ago
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üåê</div>
                    <h2>No Weather Data Available</h2>
                    <p>
                        {% if search_query %}
                            No airports found matching "{{ search_query }}"
                        {% else %}
                            Weather data will appear here once airports are added
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <script>
        // Auto-refresh every 5 minutes for updated weather
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
{% endblock %}

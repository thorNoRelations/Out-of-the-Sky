name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    name: OpenAI Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/*.py
            **/*.html
            **/*.css
            **/*.js

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install OpenAI SDK (FIXED)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir "openai==1.40.6" "httpx==0.27.0"

          python - << 'EOF'
          import openai, httpx
          print("openai version:", openai.__version__)
          print("httpx version:", httpx.__version__)
          EOF

      - name: Perform AI Code Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPEN_AI_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          python - << 'EOF'
          import os
          import sys
          from openai import OpenAI

          api_key = os.environ.get("OPEN_AI_KEY")
          if not api_key:
              print("‚ö†Ô∏è OPENAI_API_KEY not set. Skipping AI review.")
              sys.exit(0)

          client = OpenAI(api_key=api_key)
          changed_files = os.environ.get("CHANGED_FILES", "").split()

          if not changed_files:
              print("No files changed. Skipping review.")
              sys.exit(0)

          print(f"üìù Reviewing {len(changed_files)} files...")
          reviews = []

          for file_path in changed_files:
              if not os.path.exists(file_path):
                  continue

              try:
                  with open(file_path, "r", encoding="utf-8") as f:
                      content = f.read()

                  if len(content) > 10000:
                      print(f"‚è≠Ô∏è Skipping {file_path} (too large)")
                      continue

                  print(f"üîç Analyzing {file_path}...")

                  prompt = f"""
You are an expert code reviewer.

Review this file:
{file_path}

Focus on:
- Code Quality
- Security
- Performance
- Bugs
- Django Best Practices (if applicable)

Provide:
- Overall assessment
- 3‚Äì5 actionable improvements (ranked by severity)


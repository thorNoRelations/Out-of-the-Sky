name: CD Pipeline - Deploy to Production

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write
      deployments: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests before deployment
        run: |
          python manage.py test
        env:
          DJANGO_SETTINGS_MODULE: myproject.settings
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}

      - name: Trigger Render Deployment
        run: |
          echo "üöÄ Triggering Render deployment..."
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          
          if [ $RESPONSE -eq 200 ] || [ $RESPONSE -eq 201 ] || [ $RESPONSE -eq 202 ]; then
            echo "‚úÖ Deployment triggered successfully! (Status: $RESPONSE)""
         
          else
            echo "‚ùå Failed to trigger deployment. Status code: $RESPONSE"
            cat response.txt
            exit 1
          fi

      - name: Wait for Render deployment
        run: |
          echo "‚è≥ Waiting for Render deployment to complete..."
          echo "This typically takes 2-5 minutes..."
          
          # Wait for deployment to start
          sleep 30
          
          # Poll deployment status
          MAX_ATTEMPTS=20
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Checking deployment status (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)..."
            
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_APP_URL }}")
            
            if [ $STATUS -eq 200 ]; then
              echo "‚úÖ Application is responding!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            sleep 15
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ö†Ô∏è  Deployment is taking longer than expected"
            echo "Check Render dashboard for status"
          fi

      - name: Verify deployment health
        run: |
          echo "üîç Verifying deployment health..."
          
          # Check if app is responding
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_APP_URL }}")
          
          echo "Application URL: ${{ secrets.RENDER_APP_URL }}"
          echo "HTTP Status Code: $STATUS"
          
          if [ $STATUS -eq 200 ]; then
            echo "‚úÖ Application is healthy and running!"
          elif [ $STATUS -eq 503 ]; then
            echo "‚ö†Ô∏è  Application is starting up (503)"
            echo "This is normal for Render free tier"
          else
            echo "‚ö†Ô∏è  Application returned status code: $STATUS"
            echo "Check Render logs for details"
          fi

      - name: Run post-deployment checks
        if: success()
        run: |
          echo "üìä Post-deployment verification..."
          
          # Check if static files are accessible
          STATIC_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_APP_URL }}/static/styles.css")
          echo "Static files status: $STATIC_STATUS"
          
          # Check admin panel
          ADMIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_APP_URL }}/admin/")
          echo "Admin panel status: $ADMIN_STATUS"
          
          echo "‚úÖ Deployment verification complete!"

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ SUCCESS' : '‚ùå FAILED';
            const appUrl = '${{ secrets.RENDER_APP_URL }}';
            
            const message = `## üöÄ Deployment ${status}
            
            **Platform:** Render
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref.replace('refs/heads/', '')}
            **Status:** ${status}
            **Time:** ${new Date().toISOString()}
            **URL:** ${appUrl}
            
            ### Deployment Details
            - Tests passed before deployment ‚úÖ
            - Render deployment triggered ‚úÖ
            - Application health check: ${status === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}
            
            ${status === 'success' ? 
              'üéâ Your application is now live!' : 
              '‚ö†Ô∏è Please check Render dashboard for deployment logs'}
            
            [View Live Site](${appUrl}) | [Render Dashboard](https://dashboard.render.com)
            `;
            
            // Try to create a commit comment
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: message
              });
              console.log('‚úÖ Commit comment created successfully');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not create commit comment:', error.message);
              console.log('Deployment status:', status);
            }

      - name: Create GitHub deployment
        if: success()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: 'production',
                description: 'Deployed to Render',
                auto_merge: false,
                required_contexts: []
              });
              
              if (deployment.data) {
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.data.id,
                  state: 'success',
                  environment_url: '${{ secrets.RENDER_APP_URL }}',
                  description: 'Deployment successful'
                });
                console.log('‚úÖ GitHub deployment created successfully');
              }
            } catch (error) {
              console.log('‚ö†Ô∏è Could not create GitHub deployment:', error.message);
            }

      - name: Deployment summary
        if: always()
        run: |
          echo "======================================"
          echo "üì¶ DEPLOYMENT SUMMARY"
          echo "======================================"
          echo "Platform: Render"
          echo "Status: ${{ job.status }}"
          echo "URL: ${{ secrets.RENDER_APP_URL }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "======================================"
